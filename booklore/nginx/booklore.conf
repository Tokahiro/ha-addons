# booklore/nginx/booklore.conf

# Support WebSocket upgrades
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 6060;

  # If you want this add-on to be Ingress-only, uncomment:
  # allow  172.30.32.2;  # HA Ingress proxy
  # deny   all;

  server_tokens off;
  client_max_body_size 1g;

  # Common proxy headers
  proxy_http_version 1.1;
  proxy_buffering off;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # WebSocket upgrade headers on ALL locations
  proxy_set_header Upgrade    $http_upgrade;
  proxy_set_header Connection $connection_upgrade;

  # Ingress base path fix: rewrite <base href="/"> if HA sends X-Ingress-Path
  # (decompress HTML so sub_filter works)
  proxy_set_header Accept-Encoding "";
  sub_filter_types text/html;
  sub_filter_once off;
  set $ingress_path "";
  if ($http_x_ingress_path != "") { set $ingress_path $http_x_ingress_path; }
  sub_filter '<base href="/"' '<base href="$ingress_path"';

  # Proxy EVERYTHING to the backend on 8080 (UI + API + WS)
  location / {
    proxy_pass http://127.0.0.1:8080;
  }

  # If BookLore exposes a dedicated WS path, this keeps it explicit:
  location /ws {
    proxy_pass http://127.0.0.1:8080/ws;
  }

  # --- Optional WORKAROUND ---
  # Settings screen may request release notes; if upstream fails here,
  # you can serve a benign empty response to avoid UI breakage:
  # location = /api/version/release-notes {
  #   return 204;
  # }
}